# Rx(Reactive Extensions) に関する用語

## イベント(Event)

概念的には、川で例えるなら川の上を流れるもの。蛇口で例えるなら粒や雫。

## ストリーム(Stream)

概念的には、川で例えるなら川そのもの。蛇口で例えるなら出てきた水の流れ。

## オブザーバブル(Observable)

概念的には、川で例えるなら川の設計図。蛇口で例えるならまだ流れていない水道の設計図や蛇口。

## 購読(Subscribe)

概念的には、川で例えるなら川の流れにコップを置くという行為。Cold Observable の場合、その瞬間に川の水が流れ出すが、Hot の場合は「すでに流れてる水を受け取り始めるだけ」。蛇口で例えるならコップを蛇口の下に置いて流れてくる水を受け取ること。Cold Observable の場合、止まっている水道の蛇口であり、ひねると水が出る。Hot Observable の場合、常に流れている滝。途中から飛び込んでコップで受け止めるイメージ。

## サンプルを交えた説明

まずは Hot Observable と Cold Observable について説明する

Hot Observable の代表例は `button.OnClickAsObservable()`

常にユーザからイベントが流れうる状態である川であり、 Subscribe （購読）する行為は川の流れにコップを置くだけなので、イベントが流れてきたら Subscribe までに記述していたイベントの反応処理を実行する

Cold Observable の代表例は以下の通り。

```cs
var cold = Observable.Range(1, 3); // ← 値の配信設計だけ
cold.Subscribe(x => Debug.Log(x)); // ← ここで初めて1,2,3が流れ出す
```

Subscribe （購読）した時に (1,2,3) が初めて生成されて流れはじめ、 Subscribe までに記述していたイベントの反応処理を実行する

### 技術的説明の余談

もう少し技術的用語を使って説明すると、「Subscribe までに記述していたイベントの反応処理」と言うのは、Rx 的には「オペレーターによって加工されたストリームに最終的に反応する OnNext ハンドラ」と言える

これをよりわかりやすく伝えるとすると、

まずハンドラとは「イベントが起きた時に実行される関数や処理」のことをいう

```cs
button.onClick.AddListener(() => Debug.Log("クリックされた！"));
```

という処理があったとき `() => Debug.Log(...)` が「クリックイベントのハンドラ」

OnNext ハンドラとは、「新しいデータが流れてきたよ」という通知のこと

OnNext に対応してあなたが書くコード（ラムダ関数など）を**「OnNext ハンドラ」**と呼ぶ

すなわち、反応処理と表現していた部分はハンドラのことである

ここでいうオペレータとは `.Where` や `.SelectMany` などの加工・変換・フィルター・結合するための「関数群」のこと

「最終的に反応する」とは

*  `.SelectMany` や `.Where` を使って イベントのデータを加工して
* 最後に `.Subscribe(...)` の中で その加工されたデータに対して反応する

ということ

```cs
Observable.Range(1, 5)
    .Where(x => x % 2 == 0)
    .Select(x => $"偶数: {x}")
    .Subscribe(msg => Debug.Log(msg));
```

この場合、 `msg => Debug.Log(msg)` が OnNext ハンドラということになる

これらを踏まえて改めてサンプルを踏まえて Rx を日本語で説明すると

### Cold Observable の場合

```cs
var cold = Observable.Range(1, 3); // ← 値の配信設計だけ
cold.Subscribe(x => Debug.Log(x)); // ← ここで初めて1,2,3が流れ出す
```

というコードがあったとき、1〜3という数値のひとまとまり（イベント）が流れ出すストリームをオブジェクトとして表現したものが var cold というオブザーバブルオブジェクトであり、このオブザーバブルによって流れてきた数値をログとして出力するという OnNext ハンドラを登録し cold オブざーばぼるを購読することで、1〜3という数値のひとまとまりをイベントとして流し、ログとして出力することができる。

もう少し補足すると、

* `Observable.Range(1, 3)` は「1〜3 の値を順番に通知（push）するオブザーバブルを生成する処理(オブザーバブルオブジェクト)」
* `.Subscribe(...)` を呼んだ時に初めて、「1 → 2 → 3 というデータ（イベント）」が流れ始める
* `.Subscribe(...)` の中に書いたラムダ式 `x => Debug.Log(x)` はOnNext ハンドラ。このハンドラがデータを1つずつ受け取り、ログ出力している。

### Hot Observable の場合

```cs
_button.OnClickAsObservable()
    .Subscribe(_ => Debug.Log("Clicked")); // ボタンが押されるまで何も起きない
```

`_button.OnClickAsObservable()` とは常にユーザの入力を待ち、入力があるたびにイベントを流すストリームである。オブザーバブルとして表現するなら `var observable = _button.OnClickAsObservable()` と表現した時の `var observable` がオブザーバブルオブジェクト。このオブザーバブルなストリームに対して押されるたびにログを出力するという OnNext ハンドラを登録し、 observable オブザーバブルを購読することで、ボタンがクリックされるたびにログが出力されるようになる。

もう少し補足すると、

* `_button.OnClickAsObservable()` は、「ボタンがクリックされるたびにイベントを流すストリーム
* このストリームは常にユーザーの入力（クリック）を監視していて、何か起きたときにリアルタイムで値を流す
* `.Subscribe(...)` によって、「クリックされたらログを出力する」OnNext ハンドラがストリームに接続される
* この場合、ボタンが押されるまでは何も起こらず、ユーザーがボタンを押したときにだけイベントが流れる

### 補足

全体的な補足として、OnNext ハンドラを購読すると表現している部分は厳密には、「通知ハンドラ（コールバック）」を オブザーバブルに渡す行為。

「オブザーバブルを購読し、OnNext ハンドラを登録する」と表現したところは「オブザーバブルを購読して、値の通知（OnNext）を受け取る」として表現しても良い
